rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // HELPER FUNCTIONS
    // =====================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email == 'vestaluminasystem@gmail.com' ||
         exists(/databases/$(database)/documents/super_admins/$(request.auth.token.email)));
    }
    
    function isWebPanel() {
      return isAuthenticated() && 
        request.auth.token.role == 'owner';
    }
    
    function isTablet() {
      return isAuthenticated() && 
        request.auth.token.role == 'tablet';
    }
    
    function isOwnerOf(ownerId) {
      return isAuthenticated() && 
        request.auth.token.ownerId == ownerId;
    }
    
    function isResourceOwner() {
      return isAuthenticated() && 
        resource.data.ownerId == request.auth.token.ownerId;
    }
    
    function isRequestOwner() {
      return isAuthenticated() && 
        request.resource.data.ownerId == request.auth.token.ownerId;
    }

    // =====================================================
    // SUPER ADMINS COLLECTION (Phase 2)
    // =====================================================
    match /super_admins/{email} {
      // Only primary admin can write
      allow read: if isSuperAdmin();
      allow write: if isAuthenticated() && 
        request.auth.token.email == 'vestaluminasystem@gmail.com';
    }

    // =====================================================
    // BACKUPS COLLECTION (Phase 2)
    // =====================================================
    match /backups/{backupId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only Cloud Functions can write
    }

    // =====================================================
    // ADMIN LOGS COLLECTION (Phase 2)
    // =====================================================
    match /admin_logs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only Cloud Functions can write
    }

    // =====================================================
    // APP CONFIG (Public read for version check)
    // =====================================================
    match /app_config/{doc} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // =====================================================
    // TENANT LINKS (Super Admin manages)
    // =====================================================
    match /tenant_links/{tenantId} {
      allow read: if isSuperAdmin() || isOwnerOf(tenantId);
      allow write: if isSuperAdmin();
    }

    // =====================================================
    // SETTINGS (Owner's settings)
    // =====================================================
    match /settings/{ownerId} {
      allow read: if isSuperAdmin() || isOwnerOf(ownerId);
      allow write: if isSuperAdmin() || isOwnerOf(ownerId);
    }

    // =====================================================
    // UNITS (Villas/Apartments)
    // =====================================================
    match /units/{unitId} {
      allow read: if isSuperAdmin() || isResourceOwner() || 
        (isTablet() && resource.data.ownerId == request.auth.token.ownerId);
      allow create: if isWebPanel() && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // BOOKINGS + GUESTS SUBCOLLECTION
    // =====================================================
    match /bookings/{bookingId} {
      allow read: if isSuperAdmin() || isResourceOwner() || 
        (isTablet() && resource.data.ownerId == request.auth.token.ownerId);
      allow create: if (isWebPanel() || isTablet()) && isRequestOwner();
      allow update: if (isWebPanel() || isTablet()) && isResourceOwner();
      allow delete: if isWebPanel() && isResourceOwner();
      
      match /guests/{guestId} {
        allow read: if isSuperAdmin() || 
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.ownerId == request.auth.token.ownerId;
        allow write: if isWebPanel() || isTablet();
      }
    }

    // =====================================================
    // SIGNATURES
    // =====================================================
    match /signatures/{signatureId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if (isWebPanel() || isTablet()) && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // CHECK-INS
    // =====================================================
    match /check_ins/{checkInId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if isTablet() && isRequestOwner();
      allow update: if (isWebPanel() || isTablet()) && isResourceOwner();
      allow delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // CLEANING LOGS
    // =====================================================
    match /cleaning_logs/{logId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if isTablet() && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // FEEDBACK
    // =====================================================
    match /feedback/{feedbackId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if isTablet() && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // GALLERY
    // =====================================================
    match /gallery/{imageId} {
      allow read: if isSuperAdmin() || isResourceOwner() || 
        (isTablet() && resource.data.ownerId == request.auth.token.ownerId);
      allow create: if isWebPanel() && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // AI LOGS
    // =====================================================
    match /ai_logs/{logId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if isTablet() && isRequestOwner();
      allow update, delete: if false;
    }

    // =====================================================
    // TABLETS
    // =====================================================
    match /tablets/{tabletId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow create: if false;
      allow update: if isSuperAdmin() || 
        (isTablet() && resource.data.ownerId == request.auth.token.ownerId);
      allow delete: if isSuperAdmin();
    }

    // =====================================================
    // ARCHIVED BOOKINGS
    // =====================================================
    match /archived_bookings/{bookingId} {
      allow read: if isSuperAdmin() || isResourceOwner();
      allow write: if isWebPanel() && isResourceOwner();
      
      match /guests/{guestId} {
        allow read: if isSuperAdmin() || 
          get(/databases/$(database)/documents/archived_bookings/$(bookingId)).data.ownerId == request.auth.token.ownerId;
        allow write: if isWebPanel();
      }
    }

    // =====================================================
    // SYSTEM NOTIFICATIONS (Super Admin)
    // =====================================================
    match /system_notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // =====================================================
    // APK UPDATES (Super Admin)
    // =====================================================
    match /apk_updates/{updateId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // =====================================================
    // SCREENSAVER IMAGES
    // =====================================================
    match /screensaver_images/{imageId} {
      allow read: if isSuperAdmin() || isResourceOwner() || 
        (isTablet() && resource.data.ownerId == request.auth.token.ownerId);
      allow create: if isWebPanel() && isRequestOwner();
      allow update, delete: if isWebPanel() && isResourceOwner();
    }

    // =====================================================
    // CATCH-ALL DENY
    // =====================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
